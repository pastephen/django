{% load i18n bsmodal %}
{% bsmodal '??' 'create-edit-modal' close_title_button=Yes header_bg_css=bg-primary %}
    {# modal body will be filled in by jQuery.load(<new_object_url>) return value #}
    ??
{% endbsmodal %}
{% trans 'Confirm Delete' as confirm_delete_title %}
{% bsmodal confirm_delete_title 'delete-modal' close_title_button=Yes header_bg_css=bg-primary %}
    <strong>{{ model_options.verbose_name }}:</strong> <span id='id_object_name'></span><br/>
    <br/>
    <p>{% trans 'Are you sure you want to delete this?' %}</p>
    <form role="form" id="delete-form" action="" method="post">
        {% csrf_token %}
        <div class="form-group">
            <button type="submit" class="btn btn-danger">{% trans 'Yes' %}</button>
            <button type="button" class="btn btn-primary" data-dismiss="modal">{% trans 'No' %}</button>
        </div>
    </form >
{% endbsmodal %}
{% trans 'Deleted' as deleted %}
{% bsmodal deleted 'delete-result-modal' close_title_button=Yes header_bg_css=bg-primary %}
    <div id='id_delete_result'></div><br/>
    <div class="text-center form-group">
        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans 'Close' %}</button>
    </div>
{% endbsmodal %}
{% bsmodal 'Create Related Object' 'create-related-modal' close_title_button=Yes header_bg_css=bg-primary %}
    {# modal body will be filled in by jQuery.load(<new_object_url>) return value #}
    <h3>Placeholder for create-related-object form</h3>
{% endbsmodal %}
<script type="text/javascript" charset="utf-8">
$(document).ready(function() {
    // same handler for New Object and Edit Object
    $("[name=create_edit_object]").click(function(evtObj) {
        evtObj.preventDefault();
        var url = $(this).data('url');
        var title = $(this).data('title');
        $('#create-edit-modal .modal-body').load(url, function () {
            $('#create-edit-modal .modal-title').text(title);
            bindAddRelated();
            $('#create-edit-modal').modal('show');
            formAjaxSubmit('#create-edit-form', '#create-edit-modal', 
                function(xhr) {
                    {% if related_field %}
                        {% if related_field_multiple %}
                            var curVal = $("#id_{{related_field}}").val();
                            $("#id_{{related_field}}").append($("<option></option>").
                                attr("value", xhr.pk).text(xhr.name));
                            curVal.push(xhr.pk);
                            $("#id_{{related_field}}").val(curVal).trigger('change');
                        {% else %}
                            $("#id_{{related_field}}").append($("<option></option>").
                                attr("value", xhr.pk).text(xhr.name)).val(xhr.pk).trigger('change');
                        {% endif %}
                    {% else %}
                        location.reload();
                    {% endif %}
                });
            });
    });
    {% if not related_field %}
    {# delete an object action handler #}
    $("a[name='delete_object']").click(function(evtObj) {
        evtObj.preventDefault();
        $('#delete-modal #id_object_name').text(
            $(evtObj.target).parents('tr').children(':nth-child(1)').text());
        $('#delete-modal .modal-body form').attr(
            'action', $(evtObj.target).parent('a').data('url'));
        $('#delete-modal').modal('show');
        formAjaxSubmit('#delete-form', '#delete-modal', 
            function(xhr) {
                var result = xhr.result;
                $("#delete-result-modal #id_delete_result").html(xhr.message);
                $('#delete-result-modal').on('hidden.bs.modal', xhr.result ? 
                    function(evtObj) { 
                        $('#delete-result-modal').off('hidden.bs.modal');
                        location.reload();
                    } : 
                    function(evtObj) { 
                        $('#delete-result-modal').off('hidden.bs.modal');
                    });
                $('#delete-result-modal').modal('show');
            }
        );
    });
    {% endif %}
    var bindAddRelated = function() {
        $(".add-another").click(function(evtObj) {
            var url = $(this).data('url');
            var title = $(this).text();
            var select = $(this).prev('select');
            $('#create-related-modal .modal-body').load(url, function () {
                $('#create-related-modal .modal-title').text(title);
                $('#create-related-modal').modal('show');
                formAjaxSubmit('#create-related-modal #create-edit-form', '#create-related-modal', 
                    function(xhr) {
                        $(select).append($("<option></option>").
                            attr("value", xhr.pk).text(xhr.name)).val(xhr.pk).trigger('change');
                    })
                });
        });
    }
    /* Adjusts the just activated modal window's z-index to a value higher 
       than the previously activated modal window's z-index. This will 
       ensure that each newly activated modal is layered on top of all 
       previously activated modals achieving the layered dialog effect.
       
       Code borrowed from: http://jsfiddle.net/CxdUQ/
    */
    $(document).on('show.bs.modal', '.modal', function (event) {
        // calculate z-index as a function of number of visible modal windows.
        var zIndex = 1040 + (10 * $('.modal:visible').length);
        $(this).css('z-index', zIndex);
        setTimeout(function() {
            $('.modal-backdrop').not('.modal-stack').css('z-index', zIndex - 1).addClass('modal-stack');
        }, 0);
    });
});
/* A simple function that uses jQuery to submit a form using AJAX 

   Parameters:
    form:
    modal:
    complete:

 */
var formAjaxSubmit = function(form, modal, complete) {
    $(form).submit(function(e) {
        e.preventDefault();
        $.ajax({
            type: $(this).attr('method'),
            url: $(this).attr('action'),
            data: $(this).serialize(),
            success: function (xhr, ajaxOptions, thrownError) {
                if ( $(xhr).find('.has-error').length > 0 ||
                     $(xhr).find('.alert').length > 0) {
                    $(modal).find('.block-content').html(xhr);
                    formAjaxSubmit(form, modal, complete);
                } else {
                    $(modal).modal('hide');
                    if (typeof complete == "function") {
                        complete(xhr); // notify caller
                    }
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
            }
        });
    });
}
</script>
